<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰PAin è¨‚è³¼è¡¨å–®</title>
    <link rel="icon" type="image/png" href="pain.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #8B5A2B;
            --primary-dark: #6B4423;
            --secondary: #F5E6D3;
            --accent: #D4A574;
        }

        body {
            background: linear-gradient(135deg, #F5E6D3 0%, #E8D4C4 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(139, 90, 43, 0.15);
        }

        /* åº•éƒ¨å›ºå®šæ¬„ */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            box-shadow: 0 -4px 20px rgba(139, 90, 43, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            border-top: 1px solid rgba(139, 90, 43, 0.2);
        }

        .total-price-display {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* é ç•™åº•éƒ¨ç©ºé–“çµ¦å›ºå®šæ¬„ */
        .content-spacer {
            height: 100px;
        }

        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th:nth-child(1),
        td:nth-child(1) {
            width: 40%;
        }

        th:nth-child(2),
        td:nth-child(2),
        th:nth-child(3),
        td:nth-child(3),
        th:nth-child(4),
        td:nth-child(4) {
            width: 20%;
        }

        .category-header {
            background: linear-gradient(135deg, #8B5A2B 0%, #6B4423 100%);
            color: white;
        }

        .category-header th {
            border: none !important;
        }

        .product-row:hover {
            background: rgba(212, 165, 116, 0.15);
        }

        .quantity-input {
            border: 2px solid #D4A574;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .quantity-input:focus {
            border-color: #8B5A2B;
            box-shadow: 0 0 0 3px rgba(139, 90, 43, 0.2);
            outline: none;
        }

        .btn-submit {
            background: linear-gradient(135deg, #8B5A2B 0%, #6B4423 100%);
            color: white;
            padding: 12px 32px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 90, 43, 0.4);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 90, 43, 0.5);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #F5E6D3;
            border-top: 3px solid #8B5A2B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .input-field {
            border: 2px solid #D4A574;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            border-color: #8B5A2B;
            box-shadow: 0 0 0 3px rgba(139, 90, 43, 0.2);
            outline: none;
        }
    </style>
</head>

<body class="p-4 md:p-6">
    <!-- å…¬å‘Šæ©«å¹… -->
    <div id="announcement-banner"
        class="hidden max-w-4xl mx-auto mb-4 p-4 bg-amber-100 border border-amber-300 rounded-xl text-amber-800 relative">
        <button onclick="closeAnnouncement()"
            class="absolute top-2 right-2 text-amber-600 hover:text-amber-800 text-xl">&times;</button>
        <p id="announcement-text" class="pr-6"></p>
    </div>

    <!-- ä¼‘æ¯ä¸­è¦†è“‹å±¤ -->
    <div id="closed-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 max-w-md text-center shadow-2xl">
            <div class="text-6xl mb-4">ğŸŒ™</div>
            <h2 class="text-2xl font-bold text-amber-800 mb-4">ç›®å‰ä¼‘æ¯ä¸­</h2>
            <p id="business-hours-info" class="text-gray-600 mb-4"></p>
            <p class="text-sm text-gray-500">è«‹æ–¼é–‹æ”¾æ™‚é–“å†ä¾†è¨‚è³¼ï¼Œæ„Ÿè¬æ‚¨ï¼</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto glass-card p-6">
        <div class="flex items-center gap-3 mb-6">
            <span class="text-4xl">ğŸ</span>
            <h2 class="text-2xl font-bold text-amber-800">æ‰PAin è¨‚è³¼è¡¨å–®</h2>
        </div>

        <!-- LINE ç™»å…¥å€å¡Š -->
        <div id="login-section" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-xl">
            <div id="login-prompt" class="text-center">
                <p class="text-gray-600 mb-3">è«‹å…ˆä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥æ‰èƒ½è¨‚è³¼</p>
                <button onclick="loginWithLine()"
                    class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314" />
                    </svg>
                    ä½¿ç”¨ LINE ç™»å…¥
                </button>
            </div>
            <div id="user-info" class="hidden flex items-center gap-3">
                <img id="user-avatar" src="" alt="é ­åƒ" class="w-12 h-12 rounded-full border-2 border-green-300">
                <div class="flex-1">
                    <p class="text-sm text-gray-500">å·²ç™»å…¥</p>
                    <p id="user-display-name" class="font-semibold text-gray-700"></p>
                </div>
                <button onclick="showMyOrders()" class="text-sm text-amber-600 hover:text-amber-800 font-medium">ğŸ“‹
                    æˆ‘çš„è¨‚å–®</button>
                <button onclick="logout()" class="text-sm text-gray-500 hover:text-red-500">ç™»å‡º</button>
            </div>
        </div>

        <!-- LINE é¡¯ç¤ºåç¨±ï¼ˆéš±è—ï¼Œç”¨æ–¼è¡¨å–®æäº¤ï¼‰ -->
        <input type="hidden" id="line-name">

        <div class="mb-6">
            <label class="block text-amber-800 font-medium mb-2">è¯çµ¡é›»è©±ï¼š</label>
            <input type="tel" id="contact-phone" class="w-full input-field p-3" placeholder="è«‹è¼¸å…¥æ‚¨çš„è¯çµ¡é›»è©±">
        </div>

        <div class="overflow-x-auto rounded-xl border border-amber-200">
            <table class="min-w-full">
                <tbody id="products-table">
                    <tr>
                        <td colspan="4" class="p-8 text-center text-amber-700">
                            <div class="loading-spinner mx-auto mb-3"></div>
                            <p>è¼‰å…¥å•†å“ä¸­...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="content-spacer"></div>
    </div>

    <!-- åº•éƒ¨å›ºå®šæ¬„ -->
    <div class="bottom-bar">
        <div class="w-full max-w-4xl mx-auto flex items-center justify-between md:justify-end md:gap-6">
            <div class="total-price-display" id="total-price">ç¸½é‡‘é¡: $0</div>
            <button onclick="submitOrder()" class="btn-submit">
                ğŸ›’ é€å‡ºè¨‚å–®
            </button>
        </div>
    </div>

    <!-- æˆ‘çš„è¨‚å–®å½ˆçª— -->
    <div id="my-orders-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-amber-800">ğŸ“‹ æˆ‘çš„è¨‚å–®è¨˜éŒ„</h3>
                <button onclick="closeMyOrdersModal()"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="my-orders-list" class="flex-1 overflow-y-auto p-4">
                <!-- è¨‚å–®å°‡ç”± JS è¼‰å…¥ -->
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //              ç³»çµ±è¨­å®šå€ (è«‹ä¿®æ”¹æ­¤è™•)
        // ==========================================

        // Google Apps Script éƒ¨ç½²ç¶²å€ (å¿…å¡«)
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwjnkIEbHbsBjwPKEPwciHfYj9joy6G74yA0H0Khjs2h3WD0ftKioaCxfWHjRkoLt0TGA/exec';

        // LINE Login è¨­å®š
        const LINE_LOGIN_REDIRECT_URI = 'https://kimi7011.github.io/pain/pain.html';

        // ==========================================
        //              ä»¥ä¸‹ç¨‹å¼ç¢¼è«‹å‹¿ä¿®æ”¹
        // ==========================================

        let products = [];
        let categories = [];
        let storeSettings = {};
        let currentUser = null; // å„²å­˜ç™»å…¥çš„ç”¨æˆ¶è³‡è¨Š

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', async () => {
            // æª¢æŸ¥ URL æ˜¯å¦æœ‰ LINE Login å›å‚³çš„ code
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (code) {
                // å¾ LINE Login è¿”å›
                await handleLineCallback(code, state);
            } else {
                // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼ˆå¾ localStorageï¼‰
                checkLoginStatus();
            }

            // ä½¿ç”¨åˆä½µ API ä¸€æ¬¡è¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰
            await loadInitData();
            updateFormState();
        });

        // ============ åˆä½µè¼‰å…¥ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰============
        async function loadInitData() {
            try {
                const response = await fetch(`${GAS_URL}?action=getInitData&_=${new Date().getTime()}`);
                const result = await response.json();

                if (result.success) {
                    products = result.products.filter(p => p.enabled);
                    categories = result.categories;
                    storeSettings = result.settings;
                    applyStoreSettings();
                    renderProducts();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('products-table').innerHTML = `
                    <tr>
                        <td colspan="4" class="p-8 text-center text-red-600">
                            è¼‰å…¥å¤±æ•—ï¼š${error.message}<br>
                            <button onclick="loadInitData()" class="mt-3 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">é‡è©¦</button>
                        </td>
                    </tr>`;
            }
        }

        // ============ LINE Login ============
        async function loginWithLine() {
            try {
                // å¾å¾Œç«¯å–å¾—æˆæ¬Š URLï¼ˆå®‰å…¨æ€§ï¼šé¿å…å‰ç«¯æš´éœ² Channel IDï¼‰
                const response = await fetch(`${GAS_URL}?action=getLineLoginUrl&redirectUri=${encodeURIComponent(LINE_LOGIN_REDIRECT_URI)}`);
                const result = await response.json();

                if (result.success) {
                    localStorage.setItem('pain_line_login_state', result.state);
                    window.location.href = result.authUrl;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å•Ÿå‹•ç™»å…¥æµç¨‹ï¼š' + error.message, 'error');
            }
        }

        async function handleLineCallback(code, state) {
            const savedState = localStorage.getItem('pain_line_login_state');
            localStorage.removeItem('pain_line_login_state');

            if (!savedState || state !== savedState) {
                Swal.fire({
                    icon: 'error',
                    title: 'é©—è­‰å¤±æ•—',
                    text: 'è«‹é‡æ–°ç™»å…¥',
                    confirmButtonText: 'ç¢ºå®š'
                });
                window.history.replaceState({}, document.title, 'pain.html');
                return;
            }

            Swal.fire({
                title: 'ç™»å…¥é©—è­‰ä¸­...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(
                    `${GAS_URL}?action=customerLineLogin&code=${encodeURIComponent(code)}&redirectUri=${encodeURIComponent(LINE_LOGIN_REDIRECT_URI)}`
                );
                const result = await response.json();

                window.history.replaceState({}, document.title, 'pain.html');

                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('pain_user', JSON.stringify(currentUser));
                    showUserInfo();
                    Swal.close();
                } else if (result.isBlacklisted) {
                    // é¡¯ç¤ºå°é–è¨Šæ¯
                    Swal.fire({
                        icon: 'error',
                        title: 'å¸³è™Ÿå·²è¢«å°é–',
                        html: `
                            <p class="mb-2">æ‚¨çš„å¸³è™Ÿå·²è¢«åœæ¬Šï¼Œç„¡æ³•ä½¿ç”¨è¨‚è³¼åŠŸèƒ½ã€‚</p>
                            <p class="text-sm text-gray-500">å°é–åŸå› ï¼š<strong>${result.reason}</strong></p>
                            ${result.blockedAt ? `<p class="text-xs text-gray-400 mt-2">å°é–æ™‚é–“ï¼š${result.blockedAt}</p>` : ''}
                        `,
                        confirmButtonText: 'äº†è§£'
                    });
                } else {
                    throw new Error(result.error || 'ç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'ç™»å…¥å¤±æ•—',
                    text: error.message
                });
            }
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('pain_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showUserInfo();
                } catch (e) {
                    localStorage.removeItem('pain_user');
                }
            }
        }

        function showUserInfo() {
            document.getElementById('login-prompt').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-avatar').src = currentUser.pictureUrl || 'https://via.placeholder.com/48';
            document.getElementById('line-name').value = currentUser.displayName;
            updateFormState();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('pain_user');
            document.getElementById('login-prompt').classList.remove('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('line-name').value = '';
            updateFormState();
        }

        function updateFormState() {
            const submitBtn = document.querySelector('.btn-submit');
            if (!currentUser) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.title = 'è«‹å…ˆç™»å…¥ LINE å¸³è™Ÿ';
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtn.title = '';
            }
        }

        // ============ æˆ‘çš„è¨‚å–®åŠŸèƒ½ ============
        let myOrders = [];

        function showMyOrders() {
            if (!currentUser) {
                Swal.fire('è«‹å…ˆç™»å…¥', 'ç™»å…¥å¾Œå³å¯æŸ¥è©¢è¨‚å–®è¨˜éŒ„', 'info');
                return;
            }
            document.getElementById('my-orders-modal').classList.remove('hidden');
            loadMyOrders();
        }

        function closeMyOrdersModal() {
            document.getElementById('my-orders-modal').classList.add('hidden');
        }

        async function loadMyOrders() {
            const listContainer = document.getElementById('my-orders-list');
            listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(`${GAS_URL}?action=getMyOrders&lineUserId=${currentUser.userId}&_=${new Date().getTime()}`);
                const result = await response.json();

                if (result.success) {
                    myOrders = result.orders;
                    renderMyOrders();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                listContainer.innerHTML = `<p class="text-center text-red-500 py-8">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
            }
        }

        function renderMyOrders() {
            const listContainer = document.getElementById('my-orders-list');

            if (!myOrders || myOrders.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 py-8">å°šç„¡è¨‚å–®è¨˜éŒ„</p>';
                return;
            }

            let html = '';
            myOrders.forEach(order => {
                const date = new Date(order.timestamp);
                const dateStr = date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

                html += `
                    <div class="border border-gray-200 rounded-xl p-4 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-amber-700 font-bold">#${order.orderId}</span>
                            <span class="text-xs text-gray-500">${dateStr}</span>
                        </div>
                        <div class="text-sm text-gray-600 whitespace-pre-line bg-gray-50 p-3 rounded mb-2">${escapeHtml(order.items)}</div>
                        <div class="text-right font-bold text-amber-800">$${order.total}</div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // ============ è¼‰å…¥åº—å®¶è¨­å®š ============
        async function loadStoreSettings() {
            try {
                const response = await fetch(`${GAS_URL}?action=getSettings&_=${new Date().getTime()}`);
                const result = await response.json();
                if (result.success) {
                    storeSettings = result.settings;
                    applyStoreSettings();
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—', error);
            }
        }

        function applyStoreSettings() {
            // é¡¯ç¤ºå…¬å‘Š
            if (String(storeSettings.announcement_enabled) === 'true' && storeSettings.announcement) {
                document.getElementById('announcement-text').textContent = storeSettings.announcement;
                document.getElementById('announcement-banner').classList.remove('hidden');
            }

            // æª¢æŸ¥ç‡Ÿæ¥­ç‹€æ…‹
            if (!storeSettings.currentlyOpen) {
                const startTime = (storeSettings.business_period_start || '').replace('T', ' ');
                const endTime = (storeSettings.business_period_end || '').replace('T', ' ');

                // æ ¼å¼åŒ–é¡¯ç¤ºï¼šåªé¡¯ç¤ºæœˆ/æ—¥ æ™‚:åˆ†
                const formatTime = (ts) => {
                    if (!ts) return 'æœªè¨­å®š';
                    return ts.substring(5, 16).replace('-', '/');
                };

                document.getElementById('business-hours-info').textContent =
                    `é–‹æ”¾è¨‚è³¼æœŸé–“ï¼š${formatTime(startTime)} ~ ${formatTime(endTime)}`;
                document.getElementById('closed-overlay').classList.remove('hidden');
            }
        }

        function closeAnnouncement() {
            document.getElementById('announcement-banner').classList.add('hidden');
        }

        // ============ è¼‰å…¥å•†å“ ============
        async function loadProducts() {
            try {
                const response = await fetch(`${GAS_URL}?action=getProducts&_=${new Date().getTime()}`);
                const result = await response.json();

                if (result.success) {
                    products = result.products.filter(p => p.enabled);
                    await loadCategories();
                    renderProducts();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('products-table').innerHTML = `
                    <tr>
                        <td colspan="4" class="p-8 text-center text-red-600">
                            è¼‰å…¥å¤±æ•—ï¼š${error.message}<br>
                            <button onclick="loadProducts()" class="mt-3 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">é‡è©¦</button>
                        </td>
                    </tr>`;
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(`${GAS_URL}?action=getCategories`);
                const result = await response.json();
                if (result.success) {
                    categories = result.categories;
                }
            } catch (error) {
                console.error('åˆ†é¡è¼‰å…¥å¤±æ•—', error);
            }
        }

        // ============ å®‰å…¨æ€§è¼”åŠ©å‡½æ•¸ ============
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
        }

        // ============ æ¸²æŸ“å•†å“ ============
        function renderProducts() {
            const tbody = document.getElementById('products-table');

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-amber-600">ç›®å‰æ²’æœ‰å•†å“</td></tr>';
                return;
            }

            // ä¾åˆ†é¡åˆ†çµ„
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });

            // æŒ‰ç…§ categories çš„é †åºæ’åˆ—åˆ†é¡
            const categoryOrder = categories.map(c => c.name);
            const sortedCategories = Object.keys(grouped).sort((a, b) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });

            let html = '';
            sortedCategories.forEach(category => {
                const items = grouped[category];
                // åˆ†é¡æ¨™é¡Œï¼ˆä½¿ç”¨ escapeHtml é˜²æ­¢ XSSï¼‰
                const safeCategory = escapeHtml(category);
                html += `
                    <tr class="category-header">
                        <th class="p-2 text-left font-semibold">${safeCategory}</th>
                        <th class="p-2">æ•¸é‡</th>
                        <th class="p-2">åƒ¹æ ¼</th>
                        <th class="p-2">é‡‘é¡</th>
                    </tr>`;

                // å•†å“åˆ—
                items.forEach(p => {
                    const safeName = escapeHtml(p.name);
                    const safeNote = escapeHtml(p.note);
                    const displayName = safeNote ? `${safeName} ${safeNote}` : safeName;
                    html += `
                        <tr class="product-row text-center border-b border-amber-100">
                            <td class="p-2 text-left text-gray-700">${displayName}</td>
                            <td class="p-2">
                                <div class="flex items-center justify-center gap-1">
                                    <button class="w-10 h-10 rounded-full bg-amber-100 text-amber-800 hover:bg-amber-200 flex items-center justify-center font-bold text-xl active:bg-amber-300 transition-colors"
                                        onclick="updateQuantity(this, -1)">-</button>
                                    <input 
                                        type="tel" 
                                        inputmode="numeric"
                                        class="quantity w-12 text-center p-1 bg-transparent border-0 focus:ring-0 font-medium text-lg text-amber-900" 
                                        data-price="${p.price}"
                                        data-name="${safeName}"
                                        value="0" 
                                        min="0" 
                                        onfocus="this.select()"
                                        onblur="setDefaultValue(this)"
                                        oninput="validateInput(this); calculateAmount()">
                                    <button class="w-10 h-10 rounded-full bg-amber-100 text-amber-800 hover:bg-amber-200 flex items-center justify-center font-bold text-xl active:bg-amber-300 transition-colors"
                                        onclick="updateQuantity(this, 1)">+</button>
                                </div>
                            </td>
                            <td class="p-2 text-amber-700 font-medium">$${p.price}</td>
                            <td class="p-2 text-amber-800 font-semibold amount">$0</td>
                        </tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        // ============ è¨ˆç®—é‡‘é¡ ============
        function calculateAmount() {
            let rows = document.querySelectorAll("#products-table tr");
            let total = 0;
            let orders = [];

            rows.forEach(row => {
                let quantityInput = row.querySelector(".quantity");
                if (quantityInput) {
                    let quantity = parseInt(quantityInput.value, 10) || 0;
                    let price = parseInt(quantityInput.getAttribute("data-price"), 10);
                    let name = quantityInput.getAttribute("data-name");
                    let amount = quantity * price;

                    row.querySelector(".amount").innerText = `$${amount}`;
                    total += amount;

                    if (quantity > 0) {
                        orders.push(`${name} x ${quantity} (${amount}å…ƒ)`);
                    }
                }
            });

            document.getElementById("total-price").innerText = `ç¸½é‡‘é¡: $${total}`;
            return { orders, total };
        }

        // ============ æäº¤è¨‚å–® ============
        async function submitOrder() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'è«‹å…ˆç™»å…¥',
                    text: 'è«‹ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥å¾Œå†é€å‡ºè¨‚å–®',
                    confirmButtonText: 'ç¢ºå®š'
                });
                return;
            }

            let orderData = calculateAmount();
            let lineName = document.getElementById("line-name").value.trim();
            let contactPhone = document.getElementById("contact-phone").value.trim();

            if (!contactPhone) {
                Swal.fire({
                    icon: 'error',
                    title: 'éŒ¯èª¤',
                    text: 'è«‹å¡«å¯«è¯çµ¡é›»è©±ï¼'
                });
                return;
            }

            if (orderData.orders.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'éŒ¯èª¤',
                    text: 'è«‹è‡³å°‘é¸æ“‡ä¸€é …å•†å“ï¼'
                });
                return;
            }

            let orderSummary = `LINEé¡¯ç¤ºåç¨±: ${lineName}
è¯çµ¡é›»è©±: ${contactPhone}

è¨‚å–®å…§å®¹:
${orderData.orders.join("\n")}

ç¸½é‡‘é¡: $${orderData.total}`.replace(/\n/g, "<br>");

            const result = await Swal.fire({
                title: 'ç¢ºèªè¨‚å–®',
                html: orderSummary,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºèªé€å‡º',
                cancelButtonText: 'å–æ¶ˆ'
            });

            if (!result.isConfirmed) return;

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            Swal.fire({
                title: 'é€å‡ºä¸­...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(`${GAS_URL}?action=submitOrder`, {
                    method: 'POST',
                    body: JSON.stringify({
                        lineName: lineName,
                        contactPhone: contactPhone,
                        orders: orderData.orders.join("\n"),
                        total: orderData.total,
                        lineUserId: currentUser?.userId || ''  // æ–°å¢ï¼šå‚³é€ç”¨æˆ¶ ID
                    })
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'è¨‚å–®å·²é€å‡ºï¼',
                        text: `è¨‚å–®ç·¨è™Ÿï¼š${data.orderId}`,
                        confirmButtonText: 'ç¢ºå®š'
                    }).then(() => {
                        // é‡ç½®è¡¨å–®
                        document.querySelectorAll('.quantity').forEach(input => input.value = '0');
                        document.querySelectorAll('.amount').forEach(td => td.innerText = '$0');
                        document.getElementById('total-price').innerText = 'ç¸½é‡‘é¡: $0';
                    });
                } else {
                    throw new Error(data.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'é€å‡ºå¤±æ•—',
                    text: error.message === 'Failed to fetch' ? 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ç‹€æ…‹' : error.message
                });
            }
        }

        // ============ è¼”åŠ©å‡½æ•¸ ============
        function updateQuantity(btn, change) {
            const input = btn.parentElement.querySelector('.quantity');
            let currentValue = parseInt(input.value, 10) || 0;
            let newValue = currentValue + change;

            if (newValue < 0) newValue = 0;

            input.value = newValue;
            calculateAmount();
        }

        function setDefaultValue(input) {
            if (input.value.trim() === '') {
                input.value = '0';
            }
        }

        function validateInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }
    </script>
</body>

</html>
