<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>揉PAin訂購表單</title>
    <link rel="icon" type="image/png" href="pain.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 固定總金額的位置 */
        #total-price {
            position: fixed;
            bottom: 90px;
            right: 24px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            table-layout: fixed;
            width: 100%;
        }

        th:nth-child(1),
        td:nth-child(1) {
            width: 40%;
        }

        th:nth-child(2),
        td:nth-child(2),
        th:nth-child(3),
        td:nth-child(3),
        th:nth-child(4),
        td:nth-child(4) {
            width: 20%;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-2xl font-bold mb-4 text-gray-700">揉PAin訂購表單</h2>

        <!-- LINE 顯示名稱與聯絡電話輸入框 -->
        <div class="mb-4">
            <label class="block text-gray-700">LINE顯示名稱：</label>
            <input type="text" id="line-name" class="w-full border rounded p-2" placeholder="請輸入您的LINE顯示名稱">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700">聯絡電話：</label>
            <input type="tel" id="contact-phone" class="w-full border rounded p-2" placeholder="請輸入您的聯絡電話">
        </div>

        <table class="min-w-full border-collapse border border-gray-300 text-gray-700">
            <tbody id="products-table">
                <tr>
                    <td colspan="4" class="p-8 text-center text-gray-500">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <p>載入商品中...</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="text-right mt-4 text-xl font-semibold text-gray-700" id="total-price">總金額: $0</div>
    </div>

    <button onclick="submitOrder()"
        class="fixed bottom-6 right-6 px-6 py-3 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition">送出訂單</button>

    <script>
        // ============ 設定 ============
        // TODO: 部署 Apps Script 後，將 URL 更新到這裡
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbx0fIaD6KpZF1MFjk5czd1QolTkJqLhOp5QdaW8ot6zTC7T9z6CZR6KWodV0Ger-L6j5A/exec';

        let products = [];

        // ============ 初始化 ============
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });

        // ============ 載入商品 ============
        async function loadProducts() {
            try {
                const response = await fetch(`${GAS_URL}?action=getProducts`);
                const result = await response.json();

                if (result.success) {
                    products = result.products.filter(p => p.enabled);
                    renderProducts();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('products-table').innerHTML = `
                    <tr>
                        <td colspan="4" class="p-8 text-center text-red-500">
                            載入失敗：${error.message}<br>
                            <button onclick="loadProducts()" class="mt-2 text-blue-500 underline">重試</button>
                        </td>
                    </tr>`;
            }
        }

        // ============ 渲染商品 ============
        function renderProducts() {
            const tbody = document.getElementById('products-table');

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500">目前沒有商品</td></tr>';
                return;
            }

            // 依分類分組
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });

            let html = '';
            Object.entries(grouped).forEach(([category, items]) => {
                // 分類標題
                html += `
                    <tr class="bg-gray-200">
                        <th class="p-1 border">${category}</th>
                        <th class="p-1 border">數量</th>
                        <th class="p-1 border">價格</th>
                        <th class="p-1 border">金額</th>
                    </tr>`;

                // 商品列
                items.forEach(p => {
                    const displayName = p.note ? `${p.name}(${p.note})` : p.name;
                    html += `
                        <tr class="hover:bg-gray-100 text-center">
                            <td class="p-1 border">${displayName}</td>
                            <td class="p-1 border">
                                <input 
                                    type="tel" 
                                    class="quantity w-full text-center border rounded p-1" 
                                    data-price="${p.price}"
                                    data-name="${p.name}"
                                    value="0" 
                                    min="0" 
                                    oninput="validateInput(this); calculateAmount()" 
                                    onblur="setDefaultValue(this)">
                            </td>
                            <td class="p-1 border">${p.price}</td>
                            <td class="p-1 border amount">0</td>
                        </tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        // ============ 計算金額 ============
        function calculateAmount() {
            let rows = document.querySelectorAll("#products-table tr");
            let total = 0;
            let orders = [];

            rows.forEach(row => {
                let quantityInput = row.querySelector(".quantity");
                if (quantityInput) {
                    let quantity = parseInt(quantityInput.value, 10) || 0;
                    let price = parseInt(quantityInput.getAttribute("data-price"), 10);
                    let name = quantityInput.getAttribute("data-name");
                    let amount = quantity * price;

                    row.querySelector(".amount").innerText = amount;
                    total += amount;

                    if (quantity > 0) {
                        orders.push(`${name} x ${quantity} (${amount}元)`);
                    }
                }
            });

            document.getElementById("total-price").innerText = `總金額: $${total}`;
            return { orders, total };
        }

        // ============ 提交訂單 ============
        async function submitOrder() {
            let orderData = calculateAmount();
            let lineName = document.getElementById("line-name").value.trim();
            let contactPhone = document.getElementById("contact-phone").value.trim();

            if (!lineName || !contactPhone) {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: '請填寫 LINE 顯示名稱與聯絡電話！'
                });
                return;
            }

            if (orderData.orders.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: '錯誤',
                    text: '請至少選擇一項商品！'
                });
                return;
            }

            let orderSummary = `LINE顯示名稱: ${lineName}
聯絡電話: ${contactPhone}

訂單內容:
${orderData.orders.join("\n")}

總金額: $${orderData.total}`.replace(/\n/g, "<br>");

            const result = await Swal.fire({
                title: '確認訂單',
                html: orderSummary,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: '確認送出',
                cancelButtonText: '取消'
            });

            if (!result.isConfirmed) return;

            // 顯示載入中
            Swal.fire({
                title: '送出中...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(`${GAS_URL}?action=submitOrder`, {
                    method: 'POST',
                    body: JSON.stringify({
                        lineName: lineName,
                        contactPhone: contactPhone,
                        orders: orderData.orders.join("\n"),
                        total: orderData.total
                    })
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '訂單已送出！',
                        text: `訂單編號：${data.orderId}`,
                        confirmButtonText: '確定'
                    }).then(() => {
                        // 重置表單
                        document.querySelectorAll('.quantity').forEach(input => input.value = '0');
                        document.querySelectorAll('.amount').forEach(td => td.innerText = '0');
                        document.getElementById('total-price').innerText = '總金額: $0';
                    });
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                Swal.fire('錯誤', '送出失敗：' + error.message, 'error');
            }
        }

        // ============ 輔助函數 ============
        function setDefaultValue(input) {
            if (input.value.trim() === '') {
                input.value = '0';
            }
        }

        function validateInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }
    </script>
</body>

</html>
