<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰PAinè¨‚è³¼è¡¨å–®</title>
    <link rel="icon" type="image/png" href="pain.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #8B5A2B;
            --primary-dark: #6B4423;
            --secondary: #F5E6D3;
            --accent: #D4A574;
        }

        body {
            background: linear-gradient(135deg, #F5E6D3 0%, #E8D4C4 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(139, 90, 43, 0.15);
        }

        /* å›ºå®šç¸½é‡‘é¡çš„ä½ç½® */
        #total-price {
            position: fixed;
            bottom: 90px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(139, 90, 43, 0.2);
            color: var(--primary);
            border: 2px solid var(--accent);
        }

        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th:nth-child(1),
        td:nth-child(1) {
            width: 40%;
        }

        th:nth-child(2),
        td:nth-child(2),
        th:nth-child(3),
        td:nth-child(3),
        th:nth-child(4),
        td:nth-child(4) {
            width: 20%;
        }

        .category-header {
            background: linear-gradient(135deg, #8B5A2B 0%, #6B4423 100%);
            color: white;
        }

        .category-header th {
            border: none !important;
        }

        .product-row:hover {
            background: rgba(212, 165, 116, 0.15);
        }

        .quantity-input {
            border: 2px solid #D4A574;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .quantity-input:focus {
            border-color: #8B5A2B;
            box-shadow: 0 0 0 3px rgba(139, 90, 43, 0.2);
            outline: none;
        }

        .btn-submit {
            background: linear-gradient(135deg, #8B5A2B 0%, #6B4423 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 90, 43, 0.4);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 90, 43, 0.5);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #F5E6D3;
            border-top: 3px solid #8B5A2B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .input-field {
            border: 2px solid #D4A574;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            border-color: #8B5A2B;
            box-shadow: 0 0 0 3px rgba(139, 90, 43, 0.2);
            outline: none;
        }
    </style>
</head>

<body class="p-4 md:p-6">
    <div class="max-w-4xl mx-auto glass-card p-6">
        <div class="flex items-center gap-3 mb-6">
            <span class="text-4xl">ğŸ</span>
            <h2 class="text-2xl font-bold text-amber-800">æ‰PAinè¨‚è³¼è¡¨å–®</h2>
        </div>

        <!-- LINE é¡¯ç¤ºåç¨±èˆ‡è¯çµ¡é›»è©±è¼¸å…¥æ¡† -->
        <div class="mb-4">
            <label class="block text-amber-800 font-medium mb-2">LINEé¡¯ç¤ºåç¨±ï¼š</label>
            <input type="text" id="line-name" class="w-full input-field p-3" placeholder="è«‹è¼¸å…¥æ‚¨çš„LINEé¡¯ç¤ºåç¨±">
        </div>
        <div class="mb-6">
            <label class="block text-amber-800 font-medium mb-2">è¯çµ¡é›»è©±ï¼š</label>
            <input type="tel" id="contact-phone" class="w-full input-field p-3" placeholder="è«‹è¼¸å…¥æ‚¨çš„è¯çµ¡é›»è©±">
        </div>

        <div class="overflow-x-auto rounded-xl border border-amber-200">
            <table class="min-w-full">
                <tbody id="products-table">
                    <tr>
                        <td colspan="4" class="p-8 text-center text-amber-700">
                            <div class="loading-spinner mx-auto mb-3"></div>
                            <p>è¼‰å…¥å•†å“ä¸­...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="text-right mt-4 text-xl font-semibold" id="total-price">ç¸½é‡‘é¡: $0</div>
    </div>

    <button onclick="submitOrder()" class="fixed bottom-6 right-6 btn-submit">
        ğŸ›’ é€å‡ºè¨‚å–®
    </button>

    <script>
        // ============ è¨­å®š ============
        // TODO: éƒ¨ç½² Apps Script å¾Œï¼Œå°‡ URL æ›´æ–°åˆ°é€™è£¡
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw87FdNqOwzoZuR9crNG0BbkTQKTCF1kYvj0seUVRXBScrn0kx6jxjkTSJ9CJ5OzBUKew/exec';

        let products = [];

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });

        // ============ è¼‰å…¥å•†å“ ============
        async function loadProducts() {
            try {
                const response = await fetch(`${GAS_URL}?action=getProducts`);
                const result = await response.json();

                if (result.success) {
                    products = result.products.filter(p => p.enabled);
                    renderProducts();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('products-table').innerHTML = `
                    <tr>
                        <td colspan="4" class="p-8 text-center text-red-600">
                            è¼‰å…¥å¤±æ•—ï¼š${error.message}<br>
                            <button onclick="loadProducts()" class="mt-3 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">é‡è©¦</button>
                        </td>
                    </tr>`;
            }
        }

        // ============ æ¸²æŸ“å•†å“ ============
        function renderProducts() {
            const tbody = document.getElementById('products-table');

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-amber-600">ç›®å‰æ²’æœ‰å•†å“</td></tr>';
                return;
            }

            // ä¾åˆ†é¡åˆ†çµ„
            const grouped = {};
            products.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });

            let html = '';
            Object.entries(grouped).forEach(([category, items]) => {
                // åˆ†é¡æ¨™é¡Œ
                html += `
                    <tr class="category-header">
                        <th class="p-2 text-left font-semibold">${category}</th>
                        <th class="p-2">æ•¸é‡</th>
                        <th class="p-2">åƒ¹æ ¼</th>
                        <th class="p-2">é‡‘é¡</th>
                    </tr>`;

                // å•†å“åˆ—
                items.forEach(p => {
                    const displayName = p.note ? `${p.name}(${p.note})` : p.name;
                    html += `
                        <tr class="product-row text-center border-b border-amber-100">
                            <td class="p-2 text-left text-gray-700">${displayName}</td>
                            <td class="p-2">
                                <input 
                                    type="tel" 
                                    class="quantity quantity-input w-full text-center p-2" 
                                    data-price="${p.price}"
                                    data-name="${p.name}"
                                    value="0" 
                                    min="0" 
                                    oninput="validateInput(this); calculateAmount()" 
                                    onblur="setDefaultValue(this)">
                            </td>
                            <td class="p-2 text-amber-700 font-medium">$${p.price}</td>
                            <td class="p-2 text-amber-800 font-semibold amount">$0</td>
                        </tr>`;
                });
            });

            tbody.innerHTML = html;
        }

        // ============ è¨ˆç®—é‡‘é¡ ============
        function calculateAmount() {
            let rows = document.querySelectorAll("#products-table tr");
            let total = 0;
            let orders = [];

            rows.forEach(row => {
                let quantityInput = row.querySelector(".quantity");
                if (quantityInput) {
                    let quantity = parseInt(quantityInput.value, 10) || 0;
                    let price = parseInt(quantityInput.getAttribute("data-price"), 10);
                    let name = quantityInput.getAttribute("data-name");
                    let amount = quantity * price;

                    row.querySelector(".amount").innerText = `$${amount}`;
                    total += amount;

                    if (quantity > 0) {
                        orders.push(`${name} x ${quantity} (${amount}å…ƒ)`);
                    }
                }
            });

            document.getElementById("total-price").innerText = `ç¸½é‡‘é¡: $${total}`;
            return { orders, total };
        }

        // ============ æäº¤è¨‚å–® ============
        async function submitOrder() {
            let orderData = calculateAmount();
            let lineName = document.getElementById("line-name").value.trim();
            let contactPhone = document.getElementById("contact-phone").value.trim();

            if (!lineName || !contactPhone) {
                Swal.fire({
                    icon: 'error',
                    title: 'éŒ¯èª¤',
                    text: 'è«‹å¡«å¯« LINE é¡¯ç¤ºåç¨±èˆ‡è¯çµ¡é›»è©±ï¼'
                });
                return;
            }

            if (orderData.orders.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'éŒ¯èª¤',
                    text: 'è«‹è‡³å°‘é¸æ“‡ä¸€é …å•†å“ï¼'
                });
                return;
            }

            let orderSummary = `LINEé¡¯ç¤ºåç¨±: ${lineName}
è¯çµ¡é›»è©±: ${contactPhone}

è¨‚å–®å…§å®¹:
${orderData.orders.join("\n")}

ç¸½é‡‘é¡: $${orderData.total}`.replace(/\n/g, "<br>");

            const result = await Swal.fire({
                title: 'ç¢ºèªè¨‚å–®',
                html: orderSummary,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'ç¢ºèªé€å‡º',
                cancelButtonText: 'å–æ¶ˆ'
            });

            if (!result.isConfirmed) return;

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            Swal.fire({
                title: 'é€å‡ºä¸­...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(`${GAS_URL}?action=submitOrder`, {
                    method: 'POST',
                    body: JSON.stringify({
                        lineName: lineName,
                        contactPhone: contactPhone,
                        orders: orderData.orders.join("\n"),
                        total: orderData.total
                    })
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'è¨‚å–®å·²é€å‡ºï¼',
                        text: `è¨‚å–®ç·¨è™Ÿï¼š${data.orderId}`,
                        confirmButtonText: 'ç¢ºå®š'
                    }).then(() => {
                        // é‡ç½®è¡¨å–®
                        document.querySelectorAll('.quantity').forEach(input => input.value = '0');
                        document.querySelectorAll('.amount').forEach(td => td.innerText = '0');
                        document.getElementById('total-price').innerText = 'ç¸½é‡‘é¡: $0';
                    });
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                Swal.fire('éŒ¯èª¤', 'é€å‡ºå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // ============ è¼”åŠ©å‡½æ•¸ ============
        function setDefaultValue(input) {
            if (input.value.trim() === '') {
                input.value = '0';
            }
        }

        function validateInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }
    </script>
</body>

</html>
